<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>אפליקציית אטרקציות עם OpenStreetMap</title>
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      * {
        box-sizing: border-box;
        font-family: Arial, sans-serif;
      }

      body {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
        background-color: #f5f5f5;
      }

      h1,
      h2,
      h3 {
        color: #333;
      }

      .app-container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .flex-container {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }

      .form-section,
      .list-section {
        flex: 1;
        min-width: 300px;
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      input[type="text"],
      select {
        width: 100%;
        padding: 8px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      button {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }

      button:hover {
        background-color: #45a049;
      }

      button.delete {
        background-color: #f44336;
      }

      button.delete:hover {
        background-color: #d32f2f;
      }

      .star-rating {
        font-size: 24px;
        margin-bottom: 15px;
      }

      .star-rating span {
        cursor: pointer;
        color: gray;
      }

      .star-rating span.active {
        color: gold;
      }

      .attraction-list {
        max-height: 500px;
        overflow-y: auto;
        padding: 0;
        list-style: none;
      }

      .attraction-item {
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        background-color: white;
      }

      .attraction-item.selected {
        background-color: #f0f8ff;
      }

      .map-container {
        margin-top: 20px;
        height: 400px;
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
      }

      .route-info {
        margin-top: 10px;
        padding: 10px;
        background-color: #e9f7ef;
        border-radius: 4px;
      }

      @media (max-width: 768px) {
        .flex-container {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <h1>אפליקציית אטרקציות וניווט</h1>

      <div class="flex-container">
        <!-- טופס הוספת/עריכת אטרקציה -->
        <div class="form-section">
          <h2 id="form-title">הוספת אטרקציה חדשה</h2>

          <div>
            <label for="attraction-name">שם:</label>
            <input type="text" id="attraction-name" placeholder="שם האטרקציה" />

            <label for="attraction-category">קטגוריה:</label>
            <select id="attraction-category">
              <option value="אתר">אתר</option>
              <option value="מסעדה">מסעדה</option>
              <option value="בית קפה">בית קפה</option>
              <option value="בר">בר</option>
              <option value="שופינג">שופינג</option>
              <option value="מקום לינה">מקום לינה</option>
            </select>

            <label for="attraction-address">כתובת:</label>
            <input
              type="text"
              id="attraction-address"
              placeholder="כתובת האטרקציה"
            />

            <label for="attraction-link">קישור לגוגל מפות:</label>
            <input
              type="text"
              id="attraction-link"
              placeholder="https://www.google.com/maps/place/..."
            />

            <label>דירוג (1-5):</label>
            <div class="star-rating" id="star-rating">
              <span data-rating="1">★</span>
              <span data-rating="2">★</span>
              <span data-rating="3">★</span>
              <span data-rating="4">★</span>
              <span data-rating="5">★</span>
            </div>

            <button id="save-btn">הוסף אטרקציה</button>
            <button id="cancel-btn" style="display: none">בטל</button>
            <input type="hidden" id="edit-id" value="" />
          </div>
        </div>

        <!-- רשימת אטרקציות -->
        <div class="list-section">
          <h2>רשימת אטרקציות</h2>

          <div>
            <label for="category-filter">סינון לפי קטגוריה:</label>
            <select id="category-filter">
              <option value="all">כל הקטגוריות</option>
              <option value="אתר">אתרים</option>
              <option value="מסעדה">מסעדות</option>
              <option value="בית קפה">בתי קפה</option>
              <option value="בר">בארים</option>
              <option value="שופינג">שופינג</option>
              <option value="מקום לינה">מקומות לינה</option>
            </select>
          </div>

          <div>
            <label for="user-location">מיקום נוכחי (קו רוחב,קו אורך):</label>
            <input
              type="text"
              id="user-location"
              placeholder="32.0853,34.7818"
            />
          </div>

          <ul class="attraction-list" id="attraction-list">
            <!-- כאן יופיעו האטרקציות -->
          </ul>
        </div>
      </div>

      <!-- מפה וניווט -->
      <div style="margin-top: 20px">
        <h2>מפה וניווט</h2>

        <div class="map-container" id="map"></div>

        <div id="route-info" class="route-info" style="display: none">
          <h3 id="route-title"></h3>
          <p><strong>מרחק הליכה משוער:</strong> <span id="distance"></span></p>
          <p><strong>זמן הגעה משוער:</strong> <span id="duration"></span></p>
        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine (לחישוב מסלולים) -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"
    />

    <script>
      // סוגי האטרקציות
      const categories = [
        "אתר",
        "מסעדה",
        "בית קפה",
        "בר",
        "שופינג",
        "מקום לינה",
      ];

      // אייקונים לכל קטגוריה
      const categoryIcons = {
        אתר: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
        מסעדה: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
        "בית קפה": "https://maps.google.com/mapfiles/ms/icons/coffeehouse.png",
        בר: "https://maps.google.com/mapfiles/ms/icons/bar.png",
        שופינג: "https://maps.google.com/mapfiles/ms/icons/shopping.png",
        "מקום לינה": "https://maps.google.com/mapfiles/ms/icons/lodging.png",
      };

      // משתנים גלובליים
      let attractions = [];
      let map;
      let userMarker;
      let attractionMarkers = [];
      let routingControl;

      // טעינת האפליקציה
      document.addEventListener("DOMContentLoaded", function () {
        // טעינת אטרקציות מה-local storage
        loadAttractions();

        // אתחול המפה
        initMap();

        // הגדרת אירועים
        setupEventListeners();

        // הצגת אטרקציות
        renderAttractions();
      });

      // טעינת אטרקציות מה-local storage
      function loadAttractions() {
        const savedAttractions = localStorage.getItem("attractions");
        if (savedAttractions) {
          attractions = JSON.parse(savedAttractions);
        }
      }

      // שמירת אטרקציות ב-local storage
      function saveAttractions() {
        localStorage.setItem("attractions", JSON.stringify(attractions));
      }

      // אתחול המפה עם OpenStreetMap
      function initMap() {
        const telAviv = [32.0853, 34.7818];
        map = L.map("map").setView(telAviv, 13);

        // הוספת מפת OpenStreetMap
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(map);

        // הוספת אירוע לחיצה על המפה להגדרת מיקום משתמש
        map.on("click", function (e) {
          setUserLocation(e.latlng.lat, e.latlng.lng);
          document.getElementById(
            "user-location"
          ).value = `${e.latlng.lat},${e.latlng.lng}`;
        });

        // עדכון סמני האטרקציות
        updateMapMarkers();
      }

      // הגדרת אירועים
      function setupEventListeners() {
        // דירוג בכוכבים
        document.querySelectorAll("#star-rating span").forEach((star) => {
          star.addEventListener("click", function () {
            const rating = parseInt(this.getAttribute("data-rating"));
            setRating(rating);
          });
        });

        // סינון אטרקציות
        document
          .getElementById("category-filter")
          .addEventListener("change", function () {
            renderAttractions();
          });

        // שמירת אטרקציה
        document
          .getElementById("save-btn")
          .addEventListener("click", saveAttraction);

        // ביטול עריכה
        document
          .getElementById("cancel-btn")
          .addEventListener("click", cancelEdit);

        // עדכון מיקום משתמש
        document
          .getElementById("user-location")
          .addEventListener("change", function () {
            const coords = this.value.split(",");
            if (coords.length === 2) {
              const lat = parseFloat(coords[0]);
              const lng = parseFloat(coords[1]);
              if (!isNaN(lat) && !isNaN(lng)) {
                setUserLocation(lat, lng);
              }
            }
          });
      }

      // הגדרת דירוג בכוכבים
      function setRating(rating) {
        const stars = document.querySelectorAll("#star-rating span");
        stars.forEach((star) => {
          const starRating = parseInt(star.getAttribute("data-rating"));
          if (starRating <= rating) {
            star.classList.add("active");
          } else {
            star.classList.remove("active");
          }
        });
      }

      // קבלת הדירוג הנוכחי
      function getCurrentRating() {
        const activeStars = document.querySelectorAll(
          "#star-rating span.active"
        );
        return activeStars.length;
      }

      // שמירת אטרקציה חדשה או עדכון אטרקציה קיימת
      function saveAttraction() {
        const name = document.getElementById("attraction-name").value.trim();
        const category = document.getElementById("attraction-category").value;
        const address = document
          .getElementById("attraction-address")
          .value.trim();
        const link = document.getElementById("attraction-link").value.trim();
        const rating = getCurrentRating();
        const editId = document.getElementById("edit-id").value;

        // בדיקת תקינות
        if (!name || !address || !link) {
          alert("אנא מלא את כל השדות");
          return;
        }

        // חילוץ קואורדינטות מהקישור
        const coords = extractCoordinatesFromLink(link);
        if (!coords) {
          alert(
            'אנא הזן קואורדינטות בפורמט: "קו רוחב,קו אורך" (לדוגמה: 32.0853,34.7818) או קישור תקין לגוגל מפות'
          );
          return;
        }

        if (editId) {
          // עריכת אטרקציה קיימת
          const index = attractions.findIndex((att) => att.id === editId);
          if (index !== -1) {
            attractions[index] = {
              id: editId,
              name,
              category,
              address,
              link,
              rating,
              coords,
            };
          }
        } else {
          // הוספת אטרקציה חדשה
          const attraction = {
            id: Date.now().toString(),
            name,
            category,
            address,
            link,
            rating,
            coords,
          };
          attractions.push(attraction);
        }

        // שמירה ועדכון תצוגה
        saveAttractions();
        renderAttractions();
        resetForm();
        updateMapMarkers();
      }

      // חילוץ קואורדינטות מקישור גוגל מפות או מקואורדינטות ישירות
      function extractCoordinatesFromLink(link) {
        try {
          // בדיקה אם זו קואורדינטה ישירה (מספר,מספר)
          const directCoords = link
            .trim()
            .match(/^(-?\d+\.\d+)\s*,\s*(-?\d+\.\d+)$/);
          if (directCoords) {
            return {
              lat: parseFloat(directCoords[1]),
              lng: parseFloat(directCoords[2]),
            };
          }

          // ניסיון לחילוץ מקישור מסוג https://www.google.com/maps/place/.../@32.0853,34.7818
          const mapLinkMatch = link.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
          if (mapLinkMatch) {
            return {
              lat: parseFloat(mapLinkMatch[1]),
              lng: parseFloat(mapLinkMatch[2]),
            };
          }

          // ניסיון לחילוץ מקישור מסוג https://www.google.com/maps?q=32.0853,34.7818
          const url = new URL(link);
          const q = url.searchParams.get("q");
          if (q) {
            const parts = q.split(",");
            if (parts.length === 2) {
              return {
                lat: parseFloat(parts[0]),
                lng: parseFloat(parts[1]),
              };
            }
          }

          return null;
        } catch {
          return null;
        }
      }

      // ביטול עריכה
      function cancelEdit() {
        resetForm();
      }

      // איפוס הטופס
      function resetForm() {
        document.getElementById("attraction-name").value = "";
        document.getElementById("attraction-address").value = "";
        document.getElementById("attraction-link").value = "";
        setRating(3);
        document.getElementById("edit-id").value = "";
        document.getElementById("save-btn").textContent = "הוסף אטרקציה";
        document.getElementById("form-title").textContent =
          "הוספת אטרקציה חדשה";
        document.getElementById("cancel-btn").style.display = "none";
      }

      // הצגת אטרקציות ברשימה
      function renderAttractions() {
        const categoryFilter = document.getElementById("category-filter").value;
        const filteredAttractions =
          categoryFilter === "all"
            ? attractions
            : attractions.filter((att) => att.category === categoryFilter);

        const listElement = document.getElementById("attraction-list");
        listElement.innerHTML = "";

        if (filteredAttractions.length === 0) {
          listElement.innerHTML = "<li>לא נמצאו אטרקציות</li>";
          return;
        }

        filteredAttractions.forEach((attraction) => {
          const li = document.createElement("li");
          li.className = "attraction-item";
          li.innerHTML = `
                    <h3>${attraction.name}</h3>
                    <p><strong>קטגוריה:</strong> ${attraction.category}</p>
                    <p><strong>כתובת:</strong> ${attraction.address}</p>
                    <p><strong>דירוג:</strong> ${"★".repeat(
                      attraction.rating
                    )}${"☆".repeat(5 - attraction.rating)}</p>
                    <p><a href="${
                      attraction.link
                    }" target="_blank">פתח בגוגל מפות</a></p>
                    <button class="route-btn" data-id="${
                      attraction.id
                    }">חשב מסלול</button>
                    <button class="edit-btn" data-id="${
                      attraction.id
                    }">ערוך</button>
                    <button class="delete-btn" data-id="${
                      attraction.id
                    }">מחק</button>
                `;
          listElement.appendChild(li);
        });

        // הוספת אירועים לכפתורים
        document.querySelectorAll(".edit-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            editAttraction(this.getAttribute("data-id"));
          });
        });

        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            deleteAttraction(this.getAttribute("data-id"));
          });
        });

        document.querySelectorAll(".route-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            calculateRoute(this.getAttribute("data-id"));
          });
        });
      }

      // עריכת אטרקציה
      function editAttraction(id) {
        const attraction = attractions.find((att) => att.id === id);
        if (!attraction) return;

        document.getElementById("attraction-name").value = attraction.name;
        document.getElementById("attraction-category").value =
          attraction.category;
        document.getElementById("attraction-address").value =
          attraction.address;
        document.getElementById("attraction-link").value = attraction.link;
        setRating(attraction.rating);
        document.getElementById("edit-id").value = attraction.id;
        document.getElementById("save-btn").textContent = "שמור שינויים";
        document.getElementById("form-title").textContent = "עריכת אטרקציה";
        document.getElementById("cancel-btn").style.display = "inline-block";
      }

      // מחיקת אטרקציה
      function deleteAttraction(id) {
        if (confirm("האם אתה בטוח שברצונך למחוק את האטרקציה?")) {
          attractions = attractions.filter((att) => att.id !== id);
          saveAttractions();
          renderAttractions();
          updateMapMarkers();
        }
      }

      // הגדרת מיקום משתמש
      function setUserLocation(lat, lng) {
        // הסרת סמן קודם אם קיים
        if (userMarker) {
          map.removeLayer(userMarker);
        }

        // הוספת סמן חדש
        userMarker = L.marker([lat, lng], {
          icon: L.icon({
            iconUrl:
              "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-blue.png",
            iconSize: [25, 41],
          }),
        })
          .addTo(map)
          .bindPopup("אתה כאן")
          .openPopup();

        // מרכז את המפה על המיקום החדש
        map.setView([lat, lng], 13);
      }

      // חישוב מסלול
      function calculateRoute(attractionId) {
        const attraction = attractions.find((att) => att.id === attractionId);
        if (!attraction || !userMarker) {
          alert("אנא הגדר מיקום נוכחי תחילה");
          return;
        }

        // הדגשת האטרקציה הנבחרת ברשימה
        document.querySelectorAll(".attraction-item").forEach((item) => {
          item.classList.remove("selected");
          if (
            item.querySelector(".route-btn").getAttribute("data-id") ===
            attractionId
          ) {
            item.classList.add("selected");
          }
        });

        // הסרת מסלול קודם אם קיים
        if (routingControl) {
          map.removeControl(routingControl);
        }

        // יצירת מסלול חדש
        routingControl = L.Routing.control({
          waypoints: [
            L.latLng(userMarker.getLatLng().lat, userMarker.getLatLng().lng),
            L.latLng(attraction.coords.lat, attraction.coords.lng),
          ],
          routeWhileDragging: true,
          showAlternatives: false,
          addWaypoints: false,
          draggableWaypoints: false,
          fitSelectedRoutes: true,
          lineOptions: {
            styles: [{ color: "#4CAF50", opacity: 0.7, weight: 5 }],
          },
          createMarker: function () {
            return null;
          }, // לא להציג סמנים על המסלול
        }).addTo(map);

        // הצגת פרטי המסלול
        routingControl.on("routesfound", function (e) {
          const routes = e.routes;
          const route = routes[0];

          const routeInfo = document.getElementById("route-info");
          document.getElementById(
            "route-title"
          ).textContent = `מסלול ל${attraction.name}`;
          document.getElementById("distance").textContent =
            route.summary.totalDistance.toFixed(0) + " מטרים";
          document.getElementById("duration").textContent =
            Math.round(route.summary.totalTime / 60) + " דקות";
          routeInfo.style.display = "block";
        });
      }

      // עדכון סמנים על המפה
      function updateMapMarkers() {
        // הסרת סמנים קודמים
        attractionMarkers.forEach((marker) => map.removeLayer(marker));
        attractionMarkers = [];

        // הוספת סמנים חדשים
        attractions.forEach((attraction) => {
          const marker = L.marker(
            [attraction.coords.lat, attraction.coords.lng],
            {
              icon: L.icon({
                iconUrl: categoryIcons[attraction.category],
                iconSize: [30, 30],
              }),
            }
          )
            .addTo(map)
            .bindPopup(attraction.name);
          attractionMarkers.push(marker);
        });
      }
    </script>
  </body>
</html>
